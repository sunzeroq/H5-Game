<html>
  <head>
    <meta charset="utf-8">
    <title></title>

    <style type="text/css">
      canvas { border: 1px solid black; }
    </style>
  </head>

  <body>
    <canvas id="id_canvas" width="800" height="600"></canvas>

    <script type="text/javascript">

    var log = console.log.bind(console);
    var imageFromPath = function(path) {
         var img = new Image();
         img.src = path;
         return img;
    }
    //object
    var Paddle = function() {
         var image = imageFromPath('Image/Wall.jpg');
         var o = {
             image: image,
             x: 300,
             y: 300,
             speed: 5,
             width: 200,
             height: 100,
         }

         o.moveleft = function() {
              o.x -= o.speed;
         }
         o.moveright = function() {
              o.x += o.speed;
         }
         o.collided = function(ball) {
              if (ball.y + ball.height >= o.y) {

                   if (ball.x <= o.x + o.width && ball.x + ball.width >= o.x) {
                         return true;
                   }
                   return false;
              }
         }

         return o;
    }
    var Ball = function() {
         var image = imageFromPath('Image/Ball.png');
         var o = {
             image: image,
             x: 400,
             y: 200,
             speedx: 5,
             speedy: 5,
             width: 50,
             height: 50,
             fired: false,
         }
         o.fire = function() {
              o.fired = true;
         }
         o.move = function() {
              if (o.fired) {
                   //fantan
                   if (o.x < 0 || o.x > 750) {
                        o.speedx *= -1;
                   }
                   if (o.y < 0 || o.y > 550) {
                        o.speedy *= -1;
                   }
                   //move
                   o.x += o.speedx;
                   o.y += o.speedy;
              }
         }

         return o;
    }
    var Block = function() {
         var image = imageFromPath('Image/Block.png');
         var o = {
             image: image,
             x: 400,
             y: 100,
             width: 60,
             height: 40,
             alive: true,
         }
         o.kill = function() {
              o.alive = false;
         }
         return o;
    }

    var GuaGame = function () {
         var g = {
              actions: {},
              keydowns: {},
         };
         var canvas = document.querySelector('#id_canvas');
         var context = canvas.getContext('2d');
         g.canvas = canvas;
         g.context = context;

         //drawImage
         g.drawImage = function(guaImage) {
              g.context.drawImage(guaImage.image, guaImage.x, guaImage.y, guaImage.width, guaImage.height);
         }

         //events
         window.addEventListener('keydown', function(event){
              g.keydowns[event.key] = true;
         })
         window.addEventListener('keyup', function(event){
              g.keydowns[event.key] = false;
         })

         //registerAction 按下key执行callback
         g.registerAction = function(key, callback){
              g.actions[key] = callback;
         }
         //循环调用，提升帧率
         setInterval(function () {
              //events
              var actions = Object.keys(g.actions);
              for (var i = 0; i < actions.length; i++) {
                   var key = actions[i];
                   //按键按下调用g.actions[key]函数
                   if (g.keydowns[key]) {
                        g.actions[key]();
                   }
              }
              //update
              g.update();
              context.clearRect(0, 0, canvas.width, canvas.height);
              //drawImage
              g.draw();
         },1000/60)

         return g;
    }

var _main = function() {
     var paddle = Paddle();
     var ball = Ball();
     var game = GuaGame();
     var block = Block();
     game.registerAction('a', function(){
         paddle.moveleft();
    });
     game.registerAction('d', function(){
         paddle.moveright();
    });
    game.registerAction('f', function(){
        ball.fire();
   });

     game.update = function() {
          ball.move();
          if (paddle.collided(ball)) {
               ball.speedx *= 1;
               ball.speedy *= -1;
          }
    }
     game.draw = function() {
         game.drawImage(paddle);
         game.drawImage(ball);
         if (block.alive) {
              game.drawImage(block);

         }

    }

}

_main();



    </script>
  </body>
</html>
